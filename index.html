<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Pizza Negotiator 3D — Plus</title>
<style>
  html, body { margin:0; height:100%; background:#1a1a1a; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  #ui {
    position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
    width: min(680px, 94vw); background: rgba(0,0,0,0.55); color: #fff;
    border-radius: 12px; padding: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.45);
    backdrop-filter: blur(3px);
  }
  #topbar {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    width: min(680px, 94vw); display:flex; gap:10px; align-items:center; justify-content:space-between;
    color:#eee; background: rgba(0,0,0,0.45); padding:8px 10px; border-radius:10px;
  }
  #personality { font-weight: 700; }
  #meters { display:flex; gap:10px; width:100%; }
  .meter { flex:1; }
  .label { font-size:12px; color:#ccc; }
  .bar { height:12px; background:#333; border-radius:6px; overflow:hidden; margin-top:4px; }
  .fill { height:100%; width:0%; transition: width 0.35s; }
  .agree { background:#4ade80; }
  .patience { background:#ef4444; }
  #dialogue { margin: 6px 0 10px; height: 88px; overflow:auto; background: rgba(255,255,255,0.07); padding:8px; border-radius:8px; }
  .line { margin: 2px 0; }
  .you { color:#93c5fd; }
  .parent { color:#fda4af; }
  #inputRow { display:flex; gap:8px; align-items:center; }
  #argument { flex:1; font-size:16px; padding:10px; border-radius:10px; border:none; outline:none; }
  #sendBtn, #retryBtn {
    border:none; border-radius:10px; font-size:16px; padding:10px 14px; cursor:pointer;
    background:#3b82f6; color:#fff;
  }
  #retryBtn { display:none; background:#22c55e; }
  #bubble {
    position:absolute; left:50%; transform: translateX(-50%);
    bottom: calc(10px + 160px);
    max-width: 80vw; width: min(520px, 80vw);
    background: #fff; color:#111; border-radius:16px; padding:10px 12px;
    box-shadow: 0 10px 24px rgba(0,0,0,0.35);
    border: 2px solid #222;
  }
  #thought { font-size: 13px; color:#555; margin-top:6px; }
</style>
</head>
<body>
<div id="topbar">
  <div id="personality">Personality: …</div>
  <div id="meters">
    <div class="meter">
      <div class="label">Agreement</div>
      <div class="bar"><div id="agreeFill" class="fill agree"></div></div>
    </div>
    <div class="meter">
      <div class="label">Patience</div>
      <div class="bar"><div id="patienceFill" class="fill patience"></div></div>
    </div>
  </div>
</div>
<div id="bubble" role="status" aria-live="polite">
  <div id="bubbleText">...</div>
  <div id="thought"></div>
</div>
<div id="ui">
  <div id="dialogue" aria-label="Conversation log"></div>
  <div id="inputRow">
    <input id="argument" type="text" placeholder="Type anything to convince them…" autocapitalize="sentences" />
    <button id="sendBtn">Convince</button>
    <button id="retryBtn">New Round</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
// ===== 3D SCENE (lightweight, iPad‑friendly) =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x2a2a2a);

// Add a soft gradient "sky" using a big hemisphere light
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
scene.add(hemi);

const dir = new THREE.DirectionalLight(0xffffff, 1.0);
dir.position.set(3, 6, 5);
scene.add(dir);

// Room: simple low‑poly walls and floor
const room = new THREE.Group();
{
  const floor = new THREE.Mesh(new THREE.PlaneGeometry(12, 12), new THREE.MeshStandardMaterial({color:0x808080, metalness:0.05, roughness:0.9}));
  floor.rotation.x = -Math.PI/2;
  floor.position.y = 0;
  room.add(floor);

  const wallMat = new THREE.MeshStandardMaterial({color:0x3c3c44, metalness:0.05, roughness:0.95});
  const backWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), wallMat);
  backWall.position.set(0, 3, -6);
  room.add(backWall);

  const leftWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), wallMat);
  leftWall.rotation.y = Math.PI/2;
  leftWall.position.set(-6, 3, 0);
  room.add(leftWall);

  const rightWall = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), wallMat);
  rightWall.rotation.y = -Math.PI/2;
  rightWall.position.set(6, 3, 0);
  room.add(rightWall);

  // Simple window as a bright quad
  const windowMat = new THREE.MeshStandardMaterial({color:0xaad7ff, emissive:0x6bbcff, emissiveIntensity: 0.45});
  const win = new THREE.Mesh(new THREE.PlaneGeometry(3, 1.6), windowMat);
  win.position.set(-2, 3.2, -5.9);
  room.add(win);

  // Table
  const tableTop = new THREE.Mesh(new THREE.BoxGeometry(3.6, 0.18, 2.2), new THREE.MeshStandardMaterial({color:0x8a5a3b, roughness:0.7}));
  tableTop.position.set(0, 0.86, -0.4);
  room.add(tableTop);

  const legGeo = new THREE.BoxGeometry(0.15, 0.9, 0.15);
  const legMat = new THREE.MeshStandardMaterial({color:0x6d422a});
  const legs = [
    new THREE.Mesh(legGeo, legMat),
    new THREE.Mesh(legGeo, legMat),
    new THREE.Mesh(legGeo, legMat),
    new THREE.Mesh(legGeo, legMat),
  ];
  legs[0].position.set(-1.65, 0.45, -1.15);
  legs[1].position.set( 1.65, 0.45, -1.15);
  legs[2].position.set(-1.65, 0.45,  0.35);
  legs[3].position.set( 1.65, 0.45,  0.35);
  legs.forEach(l => room.add(l));
}
scene.add(room);

// Parent: simple stylized low‑poly character with minimal rig
const parent = new THREE.Group();
{
  const torso = new THREE.Mesh(new THREE.CapsuleGeometry(0.55, 0.9, 6, 10), new THREE.MeshStandardMaterial({color:0x5b7c99}));
  torso.position.set(0, 1.4, 0);
  parent.add(torso);

  const head = new THREE.Mesh(new THREE.SphereGeometry(0.42, 24, 18), new THREE.MeshStandardMaterial({color:0xffddb3}));
  head.position.set(0, 2.34, 0);
  parent.add(head);

  // Eyes
  const eyeGeo = new THREE.SphereGeometry(0.07, 14, 12);
  const whiteMat = new THREE.MeshStandardMaterial({color:0xffffff});
  const leftEye = new THREE.Mesh(eyeGeo, whiteMat);
  const rightEye = new THREE.Mesh(eyeGeo, whiteMat);
  leftEye.position.set(-0.16, 2.40, 0.35);
  rightEye.position.set( 0.16, 2.40, 0.35);
  parent.add(leftEye, rightEye);

  const pupilGeo = new THREE.SphereGeometry(0.035, 12, 10);
  const pupilMat = new THREE.MeshStandardMaterial({color:0x222222, emissive:0x111111, emissiveIntensity:0.25});
  const lP = new THREE.Mesh(pupilGeo, pupilMat);
  const rP = new THREE.Mesh(pupilGeo, pupilMat);
  lP.position.set(-0.16, 2.39, 0.42);
  rP.position.set( 0.16, 2.39, 0.42);
  parent.add(lP, rP);

  // Simple mouth (cylinder lip) that we scale while "talking"
  const mouth = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.08, 0.02, 12), new THREE.MeshStandardMaterial({color:0x772222}));
  mouth.rotation.x = Math.PI/2;
  mouth.position.set(0, 2.26, 0.42);
  parent.add(mouth);
  parent.userData.mouth = mouth;

  // Arms (just to add life)
  const armGeo = new THREE.CapsuleGeometry(0.12, 0.5, 4, 8);
  const armMat = new THREE.MeshStandardMaterial({color:0x5b7c99});
  const lArm = new THREE.Mesh(armGeo, armMat);
  const rArm = new THREE.Mesh(armGeo, armMat);
  lArm.position.set(-0.75, 1.45, 0.1);
  rArm.position.set( 0.75, 1.45, 0.1);
  parent.add(lArm, rArm);

  parent.position.set(0, 0, 0);
}
scene.add(parent);

// Camera
const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 1.8, 3.2);
camera.lookAt(0, 1.8, 0);

// Renderer
const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:'high-performance'});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);
document.body.prepend(renderer.domElement);

// Subtle idle animation
let t0 = performance.now();
function animate(){
  requestAnimationFrame(animate);
  const t = (performance.now() - t0) / 1000;
  parent.rotation.y = Math.sin(t * 0.25) * 0.05;
  const mouth = parent.userData.mouth;
  if (mouth && window.__talkingUntil && performance.now() < window.__talkingUntil) {
    const s = 1 + Math.abs(Math.sin(t * 12)) * 1.4;
    mouth.scale.set(1, s, 1);
  } else if (mouth) {
    mouth.scale.set(1, 1, 1);
  }
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

// ===== GAME LOGIC =====
const personalities = [
  {
    name: "Strict",
    likes: ["homework","grades","study","respect","responsible","promise"],
    hates: ["pizza","junk","game","games","late","videogame","tiktok"],
    tips: "Mention responsibility, homework done, or a promise to keep a schedule."
  },
  {
    name: "Frugal",
    likes: ["cheap","discount","coupon","deal","sale","leftovers","share","budget"],
    hates: ["expensive","waste","delivery","extra","tip"],
    tips: "Emphasize discounts, sharing, or staying on budget."
  },
  {
    name: "Health‑conscious",
    likes: ["healthy","salad","protein","thin","whole","vegetable","balanced","workout","gym"],
    hates: ["greasy","fat","oil","extra cheese","stuffed crust","sugar"],
    tips: "Talk about balanced toppings, thin crust, or protein options."
  },
  {
    name: "Distracted",
    likes: ["quick","fast","later","short","summary","one minute"],
    hates: ["long","boring","essay","paragraph"],
    tips: "Keep it short and clear. One strong point works best."
  },
  {
    name: "Suspicious",
    likes: ["truth","honest","promise","evidence","proof","because"],
    hates: ["lie","fake","secret","hide"],
    tips: "Be honest, give a reason, and promise to do something helpful."
  }
];
let current = null;
let agreement = 0;
let patience = 100;
const agreeFill = document.getElementById('agreeFill');
const patienceFill = document.getElementById('patienceFill');
const personalityEl = document.getElementById('personality');
const dialogue = document.getElementById('dialogue');
const bubbleText = document.getElementById('bubbleText');
const thoughtEl = document.getElementById('thought');
const argInput = document.getElementById('argument');
const sendBtn = document.getElementById('sendBtn');
const retryBtn = document.getElementById('retryBtn');

function setBars(){
  agreeFill.style.width = agreement + '%';
  patienceFill.style.width = patience + '%';
}
function sayParent(text, thought=""){
  bubbleText.textContent = text;
  thoughtEl.textContent = thought ? "Tip: " + thought : "";
  // add to log
  const p = document.createElement('div');
  p.className = 'line parent';
  p.textContent = "Parent: " + text;
  dialogue.appendChild(p);
  dialogue.scrollTop = dialogue.scrollHeight;
  // simple talk anim + optional TTS
  window.__talkingUntil = performance.now() + Math.min(2500, 600 + text.length * 30);
  try {
    if ('speechSynthesis' in window) {
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1;
      u.pitch = 1.0;
      u.volume = 1.0;
      // Prefer an English voice if available
      const v = speechSynthesis.getVoices().find(v=>/en|US|UK/i.test(v.lang));
      if (v) u.voice = v;
      speechSynthesis.cancel();
      speechSynthesis.speak(u);
    }
  } catch(e){ /* ignore */ }
}
function sayYou(text){
  const y = document.createElement('div');
  y.className = 'line you';
  y.textContent = "You: " + text;
  dialogue.appendChild(y);
  dialogue.scrollTop = dialogue.scrollHeight;
}

function personalityReply(pers, input){
  const t = input.toLowerCase();
  let score = 0;
  let hints = [];
  let negativeHits = 0;
  let positiveHits = 0;

  // reward variety & penalize repetition
  const uniqueWords = new Set(t.split(/[^a-zA-Z]+/).filter(Boolean));
  if (uniqueWords.size >= 6) score += 5;
  if (/(pizza).*\1/.test(t)) score -= 5; // repeating pizza

  // check likes/hates
  pers.likes.forEach(w => { if (t.includes(w)) { score += 15; positiveHits++; hints.push("Good: '"+w+"'"); } });
  pers.hates.forEach(w => { if (t.includes(w)) { score -= 20; negativeHits++; hints.push("Bad: '"+w+"'"); } });

  // general logic bonuses
  if (/because|so that|if.*then|in return/i.test(input)) score += 10;
  if (/please|promise|i will|i'll|i shall/i.test(input)) score += 6;
  if (/homework|chores?|dishes|clean/i.test(input)) score += 8;

  // difficulty: base patience loss
  let patienceLoss = 10 + Math.max(0, 4 - positiveHits) * 2 + negativeHits * 3;
  let msg;
  if (score >= 20) {
    msg = (pers.name === "Distracted") ? "Make it quick—okay, that actually sounds fine." : "Hmm… that's reasonable.";
  } else if (score >= 8) {
    msg = "Maybe. Keep going.";
  } else if (score > 0) {
    msg = "I'm listening, but not convinced yet.";
  } else if (score <= -20) {
    msg = "Nope. That made it worse.";
  } else {
    msg = "Not buying it.";
  }

  let tip = "";
  if (positiveHits === 0) tip = pers.tips;
  else if (negativeHits > 0) tip = "Avoid: " + pers.hates.slice(0,3).join(", ");
  else if (positiveHits > 0 && positiveHits < 2) tip = "Add one more point they care about.";

  return { score, patienceLoss, msg, tip };
}

function resetRound(){
  current = personalities[Math.floor(Math.random()*personalities.length)];
  agreement = 0;
  patience = 85; // hard but fair
  setBars();
  personalityEl.textContent = "Personality: " + current.name;
  dialogue.textContent = "";
  sayParent("Alright, what's your case?", current.tips);
  retryBtn.style.display = 'none';
  sendBtn.disabled = false;
  argInput.disabled = false;
  argInput.value = "";
  argInput.focus();
}

sendBtn.addEventListener('click', () => {
  if (agreement >= 100 || patience <= 0) return;
  const text = argInput.value.trim();
  if (!text) return;
  sayYou(text);
  argInput.value = "";
  const { score, patienceLoss, msg, tip } = personalityReply(current, text);
  agreement = Math.max(0, Math.min(100, agreement + score));
  patience = Math.max(0, patience - patienceLoss);
  setBars();
  if (agreement >= 100) {
    sayParent("Fine. Pizza it is. 🍕", "You matched their values. Nice.");
    sendBtn.disabled = true; argInput.disabled = true; retryBtn.style.display = 'inline-block';
  } else if (patience <= 0) {
    sayParent("Enough. No pizza.", "Try shorter, sharper points next time.");
    sendBtn.disabled = true; argInput.disabled = true; retryBtn.style.display = 'inline-block';
  } else {
    sayParent(msg, tip);
  }
});

retryBtn.addEventListener('click', resetRound);
argInput.addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') sendBtn.click();
});

// Start
resetRound();
</script>
</body>
</html>
